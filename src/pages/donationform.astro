---
import Layout from "../layouts/Layout.astro";
---

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<Layout>
  <section class="container donation-form">
    <div class="row mb-5 justify-content-center">
      <div class="donation-form-box container">
        <div class="p-4">
          <div class="blue-box">
            <h4 class="white-text">Total Amount</h4>
            <p id="total-amount" class="amount">₹0</p>
          </div>
          <div class="d-flex justify-content-between">
            <p class="text-muted">Premier Support</p>
            <p class="text-dark fw-bold amount" id="donationAmountDisplays">₹0</p>
          </div>
          <hr />
          <div class="d-flex justify-content-between">
            <h5 class="text-primary">Total</h5>
            <h5 class="fw-bold amount" id="donationAmountDisplay">₹0</h5>
          </div>
        </div>
      </div>
    </div>

    <div class="row justify-content-center">
      <div class="col-md-8">
        <form id="donation-form" class="p-5 border-2">
          <h4 class="mb-4">Enter Contact Information</h4>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="name" class="form-label">Full Name</label>
              <input
                type="text"
                class="form-control shadow-sm"
                id="name"
                name="name"
                placeholder="Your name"
                required
              />
            </div>
            <div class="col-md-6 mb-3">
              <label for="email" class="form-label">Email</label>
              <input
                type="email"
                class="form-control shadow-sm"
                id="email"
                name="email"
                placeholder="Email address"
                required
              />
            </div>
          </div>
          <div class="mb-3">
            <label for="phone" class="form-label">Phone</label>
            <input
              type="tel"
              class="form-control shadow-sm"
              id="phone"
              name="phone"
              placeholder="Phone number"
              required
            />
          </div>

          <h4 class="mt-5 mb-4">Enter Billing Information</h4>
          <div class="mb-3">
            <label for="country" class="form-label">Country</label>
            <input
              type="text"
              class="form-control shadow-sm"
              id="country"
              name="country"
              value="India"
              readonly
            />
          </div>
          <div class="mb-3">
            <label for="address" class="form-label">Address</label>
            <input
              type="text"
              class="form-control shadow-sm"
              id="address"
              name="address"
              placeholder="Address"
              required
            />
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="city" class="form-label">City</label>
              <input
                type="text"
                class="form-control shadow-sm"
                id="city"
                name="city"
                placeholder="City"
                required
              />
            </div>
            <div class="col-md-6 mb-3">
              <label for="state" class="form-label">State</label>
              <input
                type="text"
                class="form-control shadow-sm"
                id="state"
                name="state"
                placeholder="State"
                required
              />
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-4">
              <label for="zipcode" class="form-label"
                >ZIP Code / Postal Code</label
              >
              <input
                type="text"
                class="form-control shadow-sm"
                id="zipcode"
                name="zipcode"
                placeholder="ZIP code"
                required
              />
            </div>
          </div>

          <!-- Donate Button -->
          <div class="text-center">
            <button
              type="submit"
              id="donate-now-button"
              class="btn btn-primary btn-lg w-100 shadow-sm"
            >
              Donate Now
            </button>
          </div>
        </form>
      </div>
    </div>
  </section>

  <script>
    declare var Razorpay: any;

    const urlParams = new URLSearchParams(window.location.search);

    const donationAmount = Number(urlParams.get("donationAmount")) || 500;

    const amountElements = document.getElementsByClassName("amount");

for (let i = 0; i < amountElements.length; i++) {
    const amountElement = amountElements[i] as HTMLTextAreaElement;
    amountElement.innerText = "₹" + donationAmount;
}


    async function initiatePayment() {
      const paymentType = urlParams.get("donationFrequency") || "onetime";
      const plan_id = urlParams.get("plan_id");
      const form = document.getElementById("donation-form") as HTMLFormElement;

      // Form Validation
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }

      // Collect data from the form
      const formData = {
        name: (document.getElementById("name") as HTMLInputElement).value,
        email: (document.getElementById("email") as HTMLInputElement).value,
        phone: (document.getElementById("phone") as HTMLInputElement).value,
        currency: "INR",
        amount: donationAmount * 100,
        plan_id: plan_id,
      };

      console.log("error here");

      try {
        // Call the backend to create an order
        if (paymentType == "onetime") {
          const response = await fetch("http://localhost:3000/create-order", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(formData),
          });

          const data = await response.json();

          console.log("no no here");

          if (!response.ok) {
            throw new Error(data.message || "Payment initiation failed");
          }

          // Initialize Razorpay with the order ID from the backend
          const options = {
            key: "rzp_test_HmglXnBOLh8qwp", // Razorpay Key ID
            amount: formData.amount, // Amount in paise
            currency: "INR",
            name: "Kiran Foundation",
            description: "Donation for Premier Support",
            image: "https://kfastro.netlify.app/favicon.ico",
            order_id: data.orderId, // Order ID generated by backend
            handler: function (response) {
              alert("Payment Successful!");
              console.log("Payment ID:", response.razorpay_payment_id);
              form.reset();
            },
            prefill: {
              name: formData.name,
              email: formData.email,
              contact: formData.phone,
            },
            theme: {
              color: "#3399cc",
            },
          };

          const rzp = new Razorpay(options);
          rzp.open();
        } else {
          const response = await fetch(
            "http://localhost:3000/create-subscription",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(formData),
            },
          );

          const data = await response.json();

          if (!response.ok) {
            throw new Error(data.message || "Payment initiation failed");
          }

          // Initialize Razorpay with the order ID from the backend
          const options = {
            key: "rzp_test_HmglXnBOLh8qwp", // Razorpay Key ID
            subscription_id: data.subscription_id, // Subscription ID generated by backend
            name: "Kiran Foundation",
            description: "Subscription for Premier Support",
            image: "https://kfastro.netlify.app/favicon.ico",
            handler: function (response) {
              alert("Subscription Successful!");
              console.log("Payment ID:", response.razorpay_payment_id);
              console.log(
                "Subscription ID:",
                response.razorpay_subscription_id,
              );
              form.reset();
            },
            prefill: {
              name: formData.name,
              email: formData.email,
              contact: formData.phone,
            },
            theme: {
              color: "#3399cc",
            },
          };

          const rzp = new Razorpay(options);
          rzp.open();
        }
      } catch (error) {
        console.error("Error initiating payment:", error);
        alert("Payment initiation failed. Please try again.");
      }
    }

    // Attach event listener to the Donate Now button
    document
      .getElementById("donate-now-button")
      .addEventListener("click", function (e) {
        e.preventDefault();
        initiatePayment();
      });
  </script>
</Layout>
