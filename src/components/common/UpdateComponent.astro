---
import type { MarkdownFile } from "../../types/Markdown";
import Heading from "./heading.astro";
import UpdateCard from "./UpdateCard.astro";

// const allUpdates = import.meta.glob<MarkdownFile>('/src/content/updates/*.md')

import { getCollection } from "astro:content";

export async function getAllUpdates() {
  return await getCollection("updates");
}

// Fetch updates properly
const allUpdates = await getAllUpdates();

// Extract frontmatter directly (no need for async mapping)
const updates = allUpdates.map((update) => ({
  ...update.data, // `data` contains frontmatter fields
}));

// console.log(updates);

const { showHighPriorityOnly = false, isMainPage = false } = Astro.props;

const filteredUpdates = updates
  .filter((update) => !showHighPriorityOnly || update.priority === "high")
  .sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());

const updatesToDisplay = showHighPriorityOnly
  ? filteredUpdates.slice(0, 3)
  : filteredUpdates;

// let updatesCountToDisplay = 6

// const updateValue = () => {
//   console.log(updatesCountToDisplay);
//   if(updatesCountToDisplay < updatesToDisplay.length){
//     updatesCountToDisplay++
//   }
// }
---

<!-- Update display section -->
<style>
  .container {
    margin-bottom: 2rem;
  }
</style>
<section
  class="container pb-4 pb-sm-3 pt- mt-lg-3 mt-xl-5 pb-5 mb-lg-5 mb-1"
  style="background-color: white;"
>
  <div class="container">
    <Heading title="Updates" />

    <div
      class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-3 g-4 mt-1"
    >
      {
        updatesToDisplay.map((update, index) => (
          // {if (index < updatesCountToDisplay) {
          // return <UpdateCard update={update} />
          // }}
          <UpdateCard update={update} />
        ))
      }
    </div>
    <!-- See More button -->
    {
      isMainPage ? (
        <div class="text-center mb-1  mt-5 ">
          <a href="/updates" class="home-button btn btn-outline-primary">
            See More
          </a>
        </div>
      ) : (
        <div class="text-center mt-4">
          {/* <button class="btn btn-primary" onclick={updateValue}>
        Show more
      </button> */}
        </div>
      )
    }
  </div>
</section>
